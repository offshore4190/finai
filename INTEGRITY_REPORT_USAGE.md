# 完整性报告使用指南（统一口径版本）

## 📊 概述

本报告工具已升级，现在提供**统一的统计口径**，确保全局、分交易所、分类型的数据计算一致性。

## 🎯 核心改进

### 1. **统一的分母/分子**
- 所有匹配率使用相同的计算方式：`匹配文件数 / 数据库记录数 × 100%`
- 确保文件系统与数据库记录按 `artifact_type` 对齐

### 2. **按类型拆分完整率**
报告现在明确区分：
- **HTML 完整率** = 已下载 HTML / 数据库中 HTML 记录
- **IMAGE 完整率** = 已下载 IMAGE / 数据库中 IMAGE 记录
- **其他类型** (xbrl, other) 同样按类型统计

### 3. **多维度统计**
报告提供三个层次的统计：

#### 层次1：全局匹配率（按类型）
```
| 文件类型 | 数据库记录数 | 文件系统文件数 | 匹配数 | 匹配率 |
|---------|------------|--------------|--------|--------|
| html    | 12,345     | 12,300       | 12,280 | 99.47% |
| image   | 45,678     | 45,500       | 45,450 | 99.50% |
| Overall | 58,023     | 57,800       | 57,730 | 99.49% |
```

#### 层次2：按交易所和类型统计
每个交易所（NASDAQ, NYSE, NYSE American, NYSE Arca）都会显示：
- 该交易所下每种文件类型的匹配率
- 该交易所的加权总分

#### 层次3：执行摘要
在报告顶部直接显示关键指标：
- 总体匹配率
- HTML 匹配率（带详细数字）
- IMAGE 匹配率（带详细数字）

### 4. **加权总分**
Overall 匹配率按数据库记录量加权计算：
```
Overall匹配率 = Σ(各类型匹配数) / Σ(各类型数据库记录数)
```

## 🚀 使用方法

### 生成报告

```bash
cd /Users/hao/Desktop/FINAI/files/filings-etl

# 生成默认报告（自动命名）
python export_integrity_report.py

# 指定输出文件名
python export_integrity_report.py -o my_report.md
```

### 报告输出

报告将保存为 Markdown 格式，包含：
- 📋 执行摘要（含按类型匹配率）
- 📁 文件系统概览
- 🗄️ 数据库记录分析
- **📐 按类型统计的完整性（统一口径）** ← 新增核心章节
  - 全局匹配率（按类型）
  - 按交易所和类型统计的完整率
- 🔍 完整性分析（总体）
- 🏢 公司覆盖率分析
- 📊 数据质量指标

## 📈 报告示例

### 执行摘要示例

```markdown
| 指标 | 数值 | 说明 |
|------|------|------|
| **完整性评分** | **95.5/100** | ⭐⭐⭐⭐⭐ 优秀 |
| 实际文件总数 | 58,023 | 本地存储的文件数量 |
| 文件总大小 | 125.5 GB | 实际占用存储空间 |
| 数据库记录数 | 58,350 | 应下载的文件记录 |
| **总体匹配率** | **99.44%** | 文件系统与数据库一致性 |
| └─ HTML匹配率 | 99.47% | HTML文件匹配率 (12,280/12,345) |
| └─ IMAGE匹配率 | 99.50% | 图片文件匹配率 (45,450/45,678) |
| 覆盖公司数 | 6,234 | 有文件的公司数量 |
```

### 按类型统计示例

```markdown
## 📐 按类型统计的完整性（统一口径）

### 全局匹配率（按类型）

| 文件类型 | 数据库记录数 | 文件系统文件数 | 匹配数 | 匹配率 |
|---------|------------|--------------|--------|--------|
| **html** | 12,345 | 12,300 | 12,280 | **99.47%** |
| **image** | 45,678 | 45,500 | 45,450 | **99.50%** |
| **xbrl** | 327 | 320 | 318 | **97.25%** |
| **Overall (加权)** | 58,350 | 58,120 | 58,048 | **99.48%** |

### 按交易所和类型统计的完整率

#### NASDAQ

| 文件类型 | 数据库记录数 | 文件系统文件数 | 匹配数 | 匹配率 |
|---------|------------|--------------|--------|--------|
| html | 7,234 | 7,200 | 7,189 | 99.38% |
| image | 28,567 | 28,450 | 28,401 | 99.42% |
| xbrl | 178 | 175 | 174 | 97.75% |
| **小计 (加权)** | 35,979 | - | 35,764 | **99.40%** |
```

## 🔧 技术细节

### 统计口径说明

1. **匹配定义**：
   - 文件路径在文件系统和数据库中都存在
   - 按 `artifact_type` 字段对齐（html, image, xbrl, other）

2. **数据库查询条件**：
   ```sql
   WHERE a.status IN ('downloaded', 'skipped')
     AND a.local_path IS NOT NULL
   ```

3. **文件类型判断**：
   - `html`: .html, .htm 扩展名
   - `image`: .png, .jpg, .jpeg, .gif 扩展名
   - `xbrl`: 位于 xbrl/ 子目录
   - `other`: 其他类型

### 加权计算公式

```
总体匹配率 = (Σ 各类型匹配数) / (Σ 各类型数据库记录数) × 100%

其中：
- HTML匹配数 + IMAGE匹配数 + XBRL匹配数 + OTHER匹配数 = 总匹配数
- HTML数据库记录 + IMAGE数据库记录 + XBRL数据库记录 + OTHER数据库记录 = 总数据库记录
```

## 📝 注意事项

1. **运行前提**：
   - 数据库可访问
   - `STORAGE_ROOT` 配置正确
   - 已有下载的文件

2. **性能考虑**：
   - 大规模数据集（10万+文件）可能需要1-2分钟
   - 使用集合（set）操作确保高效比对

3. **报告格式**：
   - Markdown 格式，可在任何支持 Markdown 的编辑器中查看
   - 建议使用 VS Code、Typora 或直接在 GitHub 上查看

## 🆘 常见问题

### Q: 为什么需要统一口径？
**A:** 避免不同维度的统计产生矛盾，确保数据可信度。

### Q: 加权总分是什么意思？
**A:** 按照各类型的数据库记录量加权平均，IMAGE占比大则权重高。

### Q: 如何解读匹配率？
**A:** 
- **≥99%**: 优秀，数据完整性很好
- **95-99%**: 良好，可能有少量缺失
- **90-95%**: 中等，建议检查
- **<90%**: 需要关注，可能有系统性问题

## 📞 相关工具

- `check_file_integrity.py`: 命令行版完整性检查（无Markdown报告）
- `query_db_summary.py`: 数据库状态概览
- `repair_failed_artifacts.py`: 修复失败的下载

---

**最后更新**: 2025-11-01
**版本**: 2.0 (统一口径版本)

