.PHONY: start db-up db-down test logs db-psql db-status venv ensure-venv

# ä¼˜å…ˆé€‰ Python 3.11ï¼Œä¸å­˜åœ¨åˆ™å›é€€åˆ°ç³»ç»Ÿ python3
PYTHON := $(shell which python3.11 2>/dev/null || which python3)

# ---------- VENV ç®¡ç† ----------
venv:
	@echo "ğŸ Creating virtual environment with: $(PYTHON)"
	@rm -rf .venv
	@$(PYTHON) -m venv .venv
	@echo "âœ… Virtualenv created with $$($(PYTHON) --version)"
	@echo "ğŸ‘‰ Activate with: source .venv/bin/activate"
	@echo "ğŸ’¡ Then: pip install -r requirements.txt"

# è‹¥ .venv ä¸å­˜åœ¨æˆ–ç¼ºå°‘ python å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ™è‡ªåŠ¨åˆ›å»º
ensure-venv:
	@if [ ! -x ".venv/bin/python" ]; then \
		echo "âš ï¸  .venv missing or invalid. Creating..."; \
		$(MAKE) venv; \
		echo "â¬‡ï¸  Installing dependencies..."; \
		. .venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt; \
	else \
		echo "âœ… venv OK: .venv/bin/python"; \
	fi

# ---------- å¼€å‘ä¸æ•°æ®åº“ ----------
start: ensure-venv db-up
	@echo "ğŸ”¹ Activating virtualenv:"
	@echo "   source .venv/bin/activate"
	@echo "âœ… Environment is ready. You can now run: python main.py ..."

db-up:
	@echo "ğŸš€ Starting Postgres via docker compose..."
	docker compose up -d
	@echo "â³ Waiting for Postgres to become ready..."
	@sleep 2
	@docker exec -it filings_postgres pg_isready -U postgres -d filings_db

db-down:
	@echo "ğŸ›‘ Stopping Postgres..."
	docker compose down

logs:
	docker compose logs -f postgres

db-psql:
	docker exec -it filings_postgres psql -U postgres -d filings_db

db-status:
	docker exec -it filings_postgres pg_isready -U postgres -d filings_db

# ---------- æµ‹è¯• ----------
test: ensure-venv
	@echo "ğŸ§ª Running tests..."
	@. .venv/bin/activate && pytest -q
